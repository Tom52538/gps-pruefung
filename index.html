<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Erfassung</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin: 0 0 5px 0;
        }
        
        .header p {
            font-size: 0.9em;
            margin: 0;
            opacity: 0.9;
        }
        
        .section {
            padding: 15px;
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            color: white;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
            font-size: 0.95em;
            padding: 12px;
        }
        
        .btn-secondary:active {
            background: #dee2e6;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .button-group .btn-secondary {
            flex: 1;
        }
        
        .stats {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-number.complete {
            color: #f97316;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .device-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .device-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .device-table tr:last-child td {
            border-bottom: none;
        }
        
        .device-table tr:hover {
            background: #f8f9fa;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas {
            display: none;
        }
        
        .camera-view {
            display: none;
        }
        
        .camera-view.active {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: black;
            z-index: 1000;
        }
        
        .camera-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            z-index: 1001;
        }
        
        .camera-info {
            position: fixed;
            bottom: 180px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            color: white;
            z-index: 1001;
        }
        
        .camera-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
        
        .camera-stat {
            text-align: center;
        }
        
        .camera-stat-number {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .camera-stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }
        
        .result-box {
            background: white;
            border: 3px solid #f97316;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            max-width: 90%;
            width: 400px;
        }
        
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
        }
        
        .result-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-item {
            margin-bottom: 15px;
        }
        
        .result-label {
            color: #666;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .result-input {
            width: 100%;
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            font-family: inherit;
        }
        
        .result-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .result-input.empty {
            border-color: #ef4444;
            background: #fee2e2;
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .result-actions button {
            flex: 1;
        }
        
        .edit-hint {
            font-size: 0.85em;
            color: #666;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
        
        .google-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .google-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .google-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        #googleLoginBtn {
            display: none;
            padding: 12px;
            font-size: 1em;
        }
        
        .icon {
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ GPS Erfassung</h1>
            <p>Handy-App | Kamera + OCR</p>
        </div>
        
        <!-- Google Drive Status - Kompakt -->
        <div class="section">
            <div id="googleStatus" class="google-status disconnected">
                <span>‚ùå</span>
                <span>Nicht mit Google Drive verbunden</span>
            </div>
            <button id="googleLoginBtn" class="btn btn-primary" style="display: block;">
                üîê Mit Google anmelden
            </button>
        </div>
        
        <!-- Scannen Section -->
        <div class="section">
            <div class="section-title">üì∑ Scannen</div>
            <button id="startCamera" class="btn btn-primary">
                üì∑ Kamera starten
            </button>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="scannedCount">0</div>
                    <div class="stat-label">Erfasst</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number complete" id="completeCount">0</div>
                    <div class="stat-label">Komplett</div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="downloadCSV" class="btn btn-secondary">üíæ CSV</button>
                <button id="clearData" class="btn btn-secondary">üóëÔ∏è L√∂schen</button>
            </div>
        </div>
        
        <!-- Camera View - Fullscreen -->
        <div class="camera-view" id="cameraView">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            
            <!-- Camera Info Overlay -->
            <div class="camera-info">
                <div class="camera-stats">
                    <div class="camera-stat">
                        <div class="camera-stat-number" id="cameraScannedCount">0</div>
                        <div class="camera-stat-label">Erfasst</div>
                    </div>
                    <div class="camera-stat">
                        <div class="camera-stat-number" id="cameraCompleteCount">0</div>
                        <div class="camera-stat-label">Komplett</div>
                    </div>
                </div>
            </div>
            
            <!-- Camera Controls -->
            <div class="camera-controls">
                <button id="captureBtn" class="btn btn-primary">üì∏ Foto machen</button>
                <button id="stopCamera" class="btn btn-secondary" style="margin-top: 10px;">‚ùå Abbrechen</button>
                <div id="ocrStatus" class="status info" style="display: none; margin-top: 10px;">
                    üîç Erkenne Text...
                </div>
            </div>
        </div>
        
        <!-- Result View -->
        <div id="resultOverlay" class="result-overlay" style="display: none;"></div>
        <div id="resultView" style="display: none;">
            <div class="result-box">
                <div class="result-title">‚úÖ Erkannt - Bearbeiten m√∂glich</div>
                <div class="result-item">
                    <div class="result-label">MODELL</div>
                    <input type="text" id="resultModel" class="result-input">
                </div>
                <div class="result-item">
                    <div class="result-label">SERIENNUMMER</div>
                    <input type="text" id="resultSerial" class="result-input">
                </div>
                <div class="edit-hint">üí° Werte k√∂nnen bearbeitet werden</div>
                <div class="result-actions">
                    <button id="closeResult" class="btn btn-secondary">Abbrechen</button>
                    <button id="acceptResult" class="btn btn-primary">‚úì Speichern</button>
                </div>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="statusMessage" style="display: none;"></div>
        
        <!-- Ger√§te Liste -->
        <div class="section">
            <div class="section-title">üìä Ger√§te</div>
            <table class="device-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Modell</th>
                        <th>S/N</th>
                        <th>Zeit</th>
                    </tr>
                </thead>
                <tbody id="deviceList">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Google Drive Configuration
        const GOOGLE_CLIENT_ID = '274960914579-6l9da1vd5vu42p729kkv5m57oh98t0lc.apps.googleusercontent.com';
        const GOOGLE_FOLDER_ID = '1SU7nYBYDFgbqzsJqHQZ3Quz-cd38MQ3Q';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let accessToken = null;
        let gapiInited = false;
        let gisInited = false;
        
        // State
        let devices = JSON.parse(localStorage.getItem('gpsDevices') || '[]');
        let stream = null;
        let currentScan = { model: null, serial: null };
        
        // Initialize Google Identity Services
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleLoginBtn').style.display = 'block';
            }
        }
        
        // Google Sign In
        document.getElementById('googleLoginBtn').addEventListener('click', handleAuthClick);
        
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showStatus('Google Login fehlgeschlagen: ' + resp.error, 'error');
                    return;
                }
                accessToken = gapi.client.getToken().access_token;
                updateGoogleStatus(true);
                showStatus('‚úÖ Mit Google Drive verbunden!', 'success');
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function updateGoogleStatus(connected) {
            const statusEl = document.getElementById('googleStatus');
            const loginBtn = document.getElementById('googleLoginBtn');
            
            if (connected) {
                statusEl.className = 'google-status connected';
                statusEl.innerHTML = '<span>‚úÖ</span><span>Mit Google Drive verbunden</span>';
                loginBtn.style.display = 'none';
            } else {
                statusEl.className = 'google-status disconnected';
                statusEl.innerHTML = '<span>‚ùå</span><span>Nicht mit Google Drive verbunden</span>';
                loginBtn.style.display = 'block';
            }
        }
        
        // Upload to Google Drive
        async function uploadToGoogleDrive() {
            if (!accessToken) {
                showStatus('Bitte erst mit Google anmelden!', 'error');
                return false;
            }
            
            try {
                const csvContent = generateCSV();
                const fileName = `GPS_Scan_${new Date().toISOString().split('T')[0]}.csv`;
                
                // Check if file already exists for today
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and '${GOOGLE_FOLDER_ID}' in parents and trashed=false`,
                    {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }
                );
                
                const searchData = await searchResponse.json();
                let response;
                
                if (searchData.files && searchData.files.length > 0) {
                    // File exists, update it
                    const fileId = searchData.files[0].id;
                    response = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': 'Bearer ' + accessToken,
                                'Content-Type': 'text/csv'
                            },
                            body: csvContent
                        }
                    );
                } else {
                    // File doesn't exist, create new
                    const metadata = {
                        name: fileName,
                        mimeType: 'text/csv',
                        parents: [GOOGLE_FOLDER_ID]
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([csvContent], { type: 'text/csv' }));
                    
                    response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        },
                        body: form
                    });
                }
                
                if (response.ok) {
                    showStatus('‚úÖ In Google Drive hochgeladen!', 'success');
                    return true;
                } else {
                    const error = await response.json();
                    showStatus('Upload fehlgeschlagen: ' + (error.error?.message || 'Unbekannter Fehler'), 'error');
                    return false;
                }
            } catch (error) {
                showStatus('Upload Fehler: ' + error.message, 'error');
                return false;
            }
        }
        
        // Generate CSV
        function generateCSV() {
            let csv = 'Modell,Seriennummer,Datum,Uhrzeit\n';
            devices.forEach(device => {
                // Remove comma from German timestamp format: "23.10.2025, 13:36:09" -> "23.10.2025 13:36:09"
                const cleanTimestamp = device.timestamp.replace(',', '');
                const parts = cleanTimestamp.split(' ').filter(p => p); // filter removes empty strings
                const datum = parts[0]; // e.g. "23.10.2025"
                const uhrzeit = parts[1]; // e.g. "13:36:09"
                csv += `${device.model},${device.serial},${datum},${uhrzeit}\n`;
            });
            return csv;
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            // Load Google API
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            document.head.appendChild(gapiScript);
            
            // GIS is already loaded via the script tag in head
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    gisLoaded();
                }
            }, 1000);
            
            updateUI();
        });
        
        // Camera functions
        document.getElementById('startCamera').addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('video').srcObject = stream;
                document.getElementById('cameraView').classList.add('active');
            } catch (error) {
                showStatus('Kamera Fehler: ' + error.message, 'error');
            }
        });
        
        document.getElementById('stopCamera').addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('cameraView').classList.remove('active');
            }
        });
        
        document.getElementById('captureBtn').addEventListener('click', async () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/png');
            
            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('cameraView').classList.remove('active');
            }
            
            // Show OCR status
            const ocrStatus = document.getElementById('ocrStatus');
            ocrStatus.style.display = 'block';
            ocrStatus.textContent = 'üîç Erkenne Text...';
            
            // Perform OCR
            try {
                const result = await Tesseract.recognize(imageData, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            ocrStatus.textContent = `üîç Erkenne Text... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });
                
                ocrStatus.style.display = 'none';
                processOCRResult(result.data.text);
            } catch (error) {
                ocrStatus.style.display = 'none';
                showStatus('OCR Fehler: ' + error.message, 'error');
            }
        });
        
        function processOCRResult(text) {
            console.log('=== OCR ROHDATEN ===');
            console.log(text);
            console.log('====================');
            
            // Extract model - flexibel f√ºr alle Formate nach "Model:"
            // Sucht nach: Model: [BUCHSTABEN][ZAHLEN]-[ZAHLEN]
            // Beispiele: ME501-4, TU600-25, GO700-10, etc.
            let model = null;
            
            // Variante 1: Suche nach "Model:" gefolgt von Modellnummer
            const modelAfterLabel = text.match(/Model[:\s]+([A-Z]{2}\d{3}-\d{1,2})/i);
            if (modelAfterLabel) {
                model = modelAfterLabel[1].toUpperCase();
                console.log('‚úì Modell gefunden (nach Label):', model);
            }
            
            // Variante 2: Direkte Suche nach Modellmuster (falls "Model:" nicht erkannt)
            if (!model) {
                const modelDirect = text.match(/\b([A-Z]{2}\d{3}-\d{1,2})\b/i);
                if (modelDirect) {
                    model = modelDirect[1].toUpperCase();
                    console.log('‚úì Modell gefunden (direkt):', model);
                }
            }
            
            if (!model) {
                console.log('‚úó Kein Modell gefunden');
            }
            
            // Extract serial number - flexibel f√ºr verschiedene L√§ngen
            // Sucht nach: S/N: [6-7 Zahlen] oder direkt nach mehreren Zahlen
            let serial = null;
            
            // Variante 1: Suche nach "S/N:" oder "S.N:" gefolgt von Zahlen
            const serialAfterLabel = text.match(/S[\/\.\s]*N[:\s]+(\d{6,7})/i);
            if (serialAfterLabel) {
                serial = serialAfterLabel[1];
                console.log('‚úì S/N gefunden (nach Label):', serial);
            }
            
            // Variante 2: Suche nach 6-7 aufeinanderfolgenden Zahlen
            if (!serial) {
                const serialDirect = text.match(/\b(\d{6,7})\b/);
                if (serialDirect) {
                    serial = serialDirect[1];
                    console.log('‚úì S/N gefunden (direkt):', serial);
                }
            }
            
            if (!serial) {
                console.log('‚úó Keine S/N gefunden');
            }
            
            // Zeige Ergebnis nur wenn mindestens ein Wert gefunden wurde
            if (model || serial) {
                currentScan = { model, serial };
                showResult(model, serial);
            } else {
                showStatus('‚ùå Kein Modell oder S/N erkannt. Bitte erneut versuchen oder manuell eingeben.', 'error');
                // Zeige trotzdem den Dialog f√ºr manuelle Eingabe
                currentScan = { model: null, serial: null };
                showResult(null, null);
            }
        }
        
        function showResult(model, serial) {
            document.getElementById('resultModel').value = model || '';
            document.getElementById('resultSerial').value = serial || '';
            document.getElementById('resultOverlay').style.display = 'block';
            document.getElementById('resultView').style.display = 'block';
        }
        
        document.getElementById('closeResult').addEventListener('click', () => {
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('resultView').style.display = 'none';
            currentScan = { model: null, serial: null };
        });
        
        document.getElementById('resultOverlay').addEventListener('click', () => {
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('resultView').style.display = 'none';
            currentScan = { model: null, serial: null };
        });
        
        document.getElementById('acceptResult').addEventListener('click', async () => {
            // Hole die Werte aus den Input-Feldern (k√∂nnen manuell bearbeitet sein)
            const model = document.getElementById('resultModel').value.trim();
            const serial = document.getElementById('resultSerial').value.trim();
            
            if (!model || !serial) {
                showStatus('‚ùå Bitte Modell und Seriennummer eingeben!', 'error');
                
                // Markiere leere Felder
                if (!model) document.getElementById('resultModel').classList.add('empty');
                if (!serial) document.getElementById('resultSerial').classList.add('empty');
                
                // Entferne Markierung nach 2 Sekunden
                setTimeout(() => {
                    document.getElementById('resultModel').classList.remove('empty');
                    document.getElementById('resultSerial').classList.remove('empty');
                }, 2000);
                
                return;
            }
            
            const device = {
                model: model.toUpperCase(),
                serial: serial,
                timestamp: new Date().toLocaleString('de-DE')
            };
            
            devices.push(device);
            localStorage.setItem('gpsDevices', JSON.stringify(devices));
            updateUI();
            
            document.getElementById('resultOverlay').style.display = 'none';
            document.getElementById('resultView').style.display = 'none';
            showStatus('‚úÖ Erfolgreich gespeichert!', 'success');
            
            // Auto-upload to Google Drive if connected
            if (accessToken) {
                await uploadToGoogleDrive();
            }
            
            currentScan = { model: null, serial: null };
        });
        
        // Download CSV
        document.getElementById('downloadCSV').addEventListener('click', () => {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GPS_Scan_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showStatus('üíæ CSV heruntergeladen', 'success');
        });
        
        // Clear data
        document.getElementById('clearData').addEventListener('click', () => {
            if (confirm('Alle Daten l√∂schen?')) {
                devices = [];
                localStorage.setItem('gpsDevices', JSON.stringify(devices));
                updateUI();
                showStatus('üóëÔ∏è Daten gel√∂scht', 'info');
            }
        });
        
        // Update UI
        function updateUI() {
            const count = devices.length;
            const completeCount = devices.filter(d => d.model && d.serial).length;
            
            document.getElementById('scannedCount').textContent = count;
            document.getElementById('completeCount').textContent = completeCount;
            
            // Update camera overlay counters if visible
            document.getElementById('cameraScannedCount').textContent = count;
            document.getElementById('cameraCompleteCount').textContent = completeCount;
            
            const tbody = document.getElementById('deviceList');
            tbody.innerHTML = '';
            
            devices.forEach((device, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${device.model}</td>
                    <td>${device.serial}</td>
                    <td>${device.timestamp.split(' ')[1]}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
