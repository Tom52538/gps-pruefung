<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Erfassung</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
            font-size: 1em;
            padding: 12px;
        }
        
        .btn-secondary:hover {
            background: #dee2e6;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .button-group .btn-secondary {
            flex: 1;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat-box {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-number.complete {
            color: #f97316;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .device-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .device-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .device-table tr:last-child td {
            border-bottom: none;
        }
        
        .device-table tr:hover {
            background: #f8f9fa;
        }
        
        #video {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        #canvas {
            display: none;
        }
        
        .camera-view {
            display: none;
        }
        
        .camera-view.active {
            display: block;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }
        
        .result-box {
            background: white;
            border: 3px solid #f97316;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .result-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-item {
            margin-bottom: 15px;
        }
        
        .result-label {
            color: #666;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .result-actions button {
            flex: 1;
        }
        
        .google-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .google-status.connected {
            border: 2px solid #10b981;
            color: #065f46;
        }
        
        .google-status.disconnected {
            border: 2px solid #ef4444;
            color: #991b1b;
        }
        
        #googleLoginBtn {
            display: none;
        }
        
        .icon {
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ GPS Erfassung</h1>
            <p>Handy-App | Kamera + OCR</p>
        </div>
        
        <!-- Google Drive Status -->
        <div class="section">
            <div class="section-title">üîê Google Drive</div>
            <div id="googleStatus" class="google-status disconnected">
                <span>‚ùå</span>
                <span>Nicht verbunden</span>
            </div>
            <button id="googleLoginBtn" class="btn btn-primary" style="display: block; margin-top: 15px;">
                Mit Google anmelden
            </button>
        </div>
        
        <!-- Scannen Section -->
        <div class="section">
            <div class="section-title">üì∑ Scannen</div>
            <button id="startCamera" class="btn btn-primary">
                üì∑ Kamera starten
            </button>
            
            <div class="button-group">
                <button id="downloadCSV" class="btn btn-secondary">üíæ CSV</button>
                <button id="clearData" class="btn btn-secondary">üóëÔ∏è L√∂schen</button>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="scannedCount">0</div>
                    <div class="stat-label">Erfasst</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number complete" id="completeCount">0</div>
                    <div class="stat-label">Komplett</div>
                </div>
            </div>
        </div>
        
        <!-- Camera View -->
        <div class="camera-view" id="cameraView">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <button id="captureBtn" class="btn btn-primary">üì∏ Foto machen</button>
            <button id="stopCamera" class="btn btn-secondary" style="margin-top: 10px;">‚ùå Abbrechen</button>
            <div id="ocrStatus" class="status info" style="display: none;">
                üîç Erkenne Text...
            </div>
        </div>
        
        <!-- Result View -->
        <div id="resultView" style="display: none;">
            <div class="result-box">
                <div class="result-title">‚úÖ Erkannt:</div>
                <div class="result-item">
                    <div class="result-label">MODELL</div>
                    <div class="result-value" id="resultModel">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">S/N</div>
                    <div class="result-value" id="resultSerial">-</div>
                </div>
                <div class="result-actions">
                    <button id="closeResult" class="btn btn-secondary">Schlie√üen</button>
                    <button id="acceptResult" class="btn btn-primary">‚úì OK</button>
                </div>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="statusMessage" style="display: none;"></div>
        
        <!-- Ger√§te Liste -->
        <div class="section">
            <div class="section-title">üìä Ger√§te</div>
            <table class="device-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Modell</th>
                        <th>S/N</th>
                        <th>Zeit</th>
                    </tr>
                </thead>
                <tbody id="deviceList">
                </tbody>
            </table>
        </div>
        
        <div class="google-status connected" style="margin-top: 20px;">
            <span>‚úÖ</span>
            <span>Kamera-OCR</span>
            <span style="margin-left: auto;">üèÜ</span>
            <span id="driveUploadStatus">Google Drive Upload (nicht verbunden)</span>
        </div>
    </div>

    <script>
        // Google Drive Configuration
        const GOOGLE_CLIENT_ID = '274960914579-6l9da1vd5vu42p729kkv5m57oh98t0lc.apps.googleusercontent.com';
        const GOOGLE_FOLDER_ID = '1SU7nYBYDFgbqzsJqHQZ3Quz-cd38MQ3Q';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let accessToken = null;
        let gapiInited = false;
        let gisInited = false;
        
        // State
        let devices = JSON.parse(localStorage.getItem('gpsDevices') || '[]');
        let stream = null;
        let currentScan = { model: null, serial: null };
        
        // Initialize Google Identity Services
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleLoginBtn').style.display = 'block';
            }
        }
        
        // Google Sign In
        document.getElementById('googleLoginBtn').addEventListener('click', handleAuthClick);
        
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showStatus('Google Login fehlgeschlagen: ' + resp.error, 'error');
                    return;
                }
                accessToken = gapi.client.getToken().access_token;
                updateGoogleStatus(true);
                showStatus('‚úÖ Mit Google Drive verbunden!', 'success');
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function updateGoogleStatus(connected) {
            const statusEl = document.getElementById('googleStatus');
            const uploadStatusEl = document.getElementById('driveUploadStatus');
            const loginBtn = document.getElementById('googleLoginBtn');
            
            if (connected) {
                statusEl.className = 'google-status connected';
                statusEl.innerHTML = '<span>‚úÖ</span><span>Verbunden mit Google Drive</span>';
                loginBtn.style.display = 'none';
                uploadStatusEl.textContent = 'Google Drive Upload (aktiv)';
            } else {
                statusEl.className = 'google-status disconnected';
                statusEl.innerHTML = '<span>‚ùå</span><span>Nicht verbunden</span>';
                loginBtn.style.display = 'block';
                uploadStatusEl.textContent = 'Google Drive Upload (nicht verbunden)';
            }
        }
        
        // Upload to Google Drive
        async function uploadToGoogleDrive() {
            if (!accessToken) {
                showStatus('Bitte erst mit Google anmelden!', 'error');
                return false;
            }
            
            try {
                const csvContent = generateCSV();
                const fileName = `GPS_Scan_${new Date().toISOString().split('T')[0]}.csv`;
                
                // Check if file already exists for today
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and '${GOOGLE_FOLDER_ID}' in parents and trashed=false`,
                    {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }
                );
                
                const searchData = await searchResponse.json();
                let response;
                
                if (searchData.files && searchData.files.length > 0) {
                    // File exists, update it
                    const fileId = searchData.files[0].id;
                    response = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': 'Bearer ' + accessToken,
                                'Content-Type': 'text/csv'
                            },
                            body: csvContent
                        }
                    );
                } else {
                    // File doesn't exist, create new
                    const metadata = {
                        name: fileName,
                        mimeType: 'text/csv',
                        parents: [GOOGLE_FOLDER_ID]
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([csvContent], { type: 'text/csv' }));
                    
                    response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        },
                        body: form
                    });
                }
                
                if (response.ok) {
                    showStatus('‚úÖ In Google Drive hochgeladen!', 'success');
                    return true;
                } else {
                    const error = await response.json();
                    showStatus('Upload fehlgeschlagen: ' + (error.error?.message || 'Unbekannter Fehler'), 'error');
                    return false;
                }
            } catch (error) {
                showStatus('Upload Fehler: ' + error.message, 'error');
                return false;
            }
        }
        
        // Generate CSV
        function generateCSV() {
            let csv = 'Modell,Seriennummer,Zeitstempel\n';
            devices.forEach(device => {
                csv += `${device.model},${device.serial},${device.timestamp}\n`;
            });
            return csv;
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            // Load Google API
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            document.head.appendChild(gapiScript);
            
            // GIS is already loaded via the script tag in head
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    gisLoaded();
                }
            }, 1000);
            
            updateUI();
        });
        
        // Camera functions
        document.getElementById('startCamera').addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('video').srcObject = stream;
                document.getElementById('cameraView').classList.add('active');
            } catch (error) {
                showStatus('Kamera Fehler: ' + error.message, 'error');
            }
        });
        
        document.getElementById('stopCamera').addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('cameraView').classList.remove('active');
            }
        });
        
        document.getElementById('captureBtn').addEventListener('click', async () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/png');
            
            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('cameraView').classList.remove('active');
            }
            
            // Show OCR status
            const ocrStatus = document.getElementById('ocrStatus');
            ocrStatus.style.display = 'block';
            ocrStatus.textContent = 'üîç Erkenne Text...';
            
            // Perform OCR
            try {
                const result = await Tesseract.recognize(imageData, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            ocrStatus.textContent = `üîç Erkenne Text... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });
                
                ocrStatus.style.display = 'none';
                processOCRResult(result.data.text);
            } catch (error) {
                ocrStatus.style.display = 'none';
                showStatus('OCR Fehler: ' + error.message, 'error');
            }
        });
        
        function processOCRResult(text) {
            console.log('OCR Text:', text);
            
            // Extract model (ME501-4, ME601-5, etc.)
            const modelMatch = text.match(/ME\s*(\d{3})\s*-?\s*(\d)/i);
            const model = modelMatch ? `ME${modelMatch[1]}-${modelMatch[2]}` : null;
            
            // Extract serial number (6 digits)
            const serialMatch = text.match(/\b(\d{6})\b/);
            const serial = serialMatch ? serialMatch[1] : null;
            
            if (model || serial) {
                currentScan = { model, serial };
                showResult(model, serial);
            } else {
                showStatus('‚ùå Kein Modell oder S/N erkannt. Bitte erneut versuchen.', 'error');
            }
        }
        
        function showResult(model, serial) {
            document.getElementById('resultModel').textContent = model || '-';
            document.getElementById('resultSerial').textContent = serial || '-';
            document.getElementById('resultView').style.display = 'block';
        }
        
        document.getElementById('closeResult').addEventListener('click', () => {
            document.getElementById('resultView').style.display = 'none';
            currentScan = { model: null, serial: null };
        });
        
        document.getElementById('acceptResult').addEventListener('click', async () => {
            if (currentScan.model && currentScan.serial) {
                const device = {
                    model: currentScan.model,
                    serial: currentScan.serial,
                    timestamp: new Date().toLocaleString('de-DE')
                };
                
                devices.push(device);
                localStorage.setItem('gpsDevices', JSON.stringify(devices));
                updateUI();
                
                document.getElementById('resultView').style.display = 'none';
                showStatus('‚úÖ Erfolgreich!', 'success');
                
                // Auto-upload to Google Drive if connected
                if (accessToken) {
                    await uploadToGoogleDrive();
                }
                
                currentScan = { model: null, serial: null };
            }
        });
        
        // Download CSV
        document.getElementById('downloadCSV').addEventListener('click', () => {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GPS_Scan_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showStatus('üíæ CSV heruntergeladen', 'success');
        });
        
        // Clear data
        document.getElementById('clearData').addEventListener('click', () => {
            if (confirm('Alle Daten l√∂schen?')) {
                devices = [];
                localStorage.setItem('gpsDevices', JSON.stringify(devices));
                updateUI();
                showStatus('üóëÔ∏è Daten gel√∂scht', 'info');
            }
        });
        
        // Update UI
        function updateUI() {
            document.getElementById('scannedCount').textContent = devices.length;
            
            const completeDevices = devices.filter(d => d.model && d.serial);
            document.getElementById('completeCount').textContent = completeDevices.length;
            
            const tbody = document.getElementById('deviceList');
            tbody.innerHTML = '';
            
            devices.forEach((device, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${device.model}</td>
                    <td>${device.serial}</td>
                    <td>${device.timestamp}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
